---
title: Deployment
date: 2023-02-10 15:13:17
permalink: /pages/db84e9/
categories:
  - CloudNative
  - Kubernetesæ¶æ„å¸ˆï¼šåŸºäºä¸–ç•Œ500å¼ºçš„k8så®æˆ˜è¯¾ç¨‹
  - 04-èµ„æºè°ƒåº¦
tags:
  - 
author: 
  name: CodeAshen
  link: https://github.com/codeashen
---
[TOC]

# Deployment æ¦‚å¿µ

ç”¨äºéƒ¨ç½²æ— çŠ¶æ€çš„æœåŠ¡ï¼Œè¿™ä¸ªæœ€å¸¸ç”¨çš„æ§åˆ¶å™¨ã€‚ä¸€èˆ¬ç”¨äºç®¡ç†ç»´æŠ¤ä¼ä¸šå†…éƒ¨æ— çŠ¶æ€çš„å¾®æœåŠ¡ï¼Œæ¯”å¦‚ configserverã€zuulã€springbootã€‚ä»–å¯ä»¥ç®¡ç†å¤šä¸ªå‰¯æœ¬çš„ Pod å®ç°æ— ç¼è¿ç§»ã€è‡ªåŠ¨æ‰©å®¹ç¼©å®¹ã€è‡ªåŠ¨ç¾éš¾æ¢å¤ã€ä¸€é”®å›æ»šç­‰åŠŸèƒ½ã€‚

# åˆ›å»ºä¸€ä¸ª Deployment

- **æ‰‹åŠ¨åˆ›å»º**

  `kubectl create deployment nginx --image=nginx:1.15.2`

- **ä»æ–‡ä»¶åˆ›å»º**

  `kubectl apply -f nginx-deploy.yaml`

  ```yaml
  apiVersion: apps/v1
  kind: Deployment
  metadata:
    annotations:
      deployment.kubernetes.io/revision: "1"
    creationTimestamp: "2020-09-19T02:41:11Z"
    generation: 1
    labels:
      app: nginx
    name: nginx
    namespace: default
  spec:
    progressDeadlineSeconds: 600
    replicas: 2 #å‰¯æœ¬æ•°
    revisionHistoryLimit: 10 # å†å²è®°å½•ä¿ç•™çš„ä¸ªæ•°
    selector:
      matchLabels:
        app: nginx
    strategy:
      rollingUpdate:
        maxSurge: 25%
        maxUnavailable: 25%
      type: RollingUpdate
    template:
      metadata:
        creationTimestamp: null
        labels:
          app: nginx
      spec:
        containers:
        - image: nginx:1.15.2
          imagePullPolicy: IfNotPresent
          name: nginx
          resources: {}
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
        dnsPolicy: ClusterFirst
        restartPolicy: Always
        schedulerName: default-scheduler
        securityContext: {}
        terminationGracePeriodSeconds: 30
  ```

- **çŠ¶æ€è§£æ**

  ```bash
  # kubectl get deploy -owide
  NAME    READY   UP-TO-DATE   AVAILABLE   AGE     CONTAINERS   IMAGES         SELECTOR
  nginx   2/2     2            2           9m29s   nginx        nginx:1.15.2   app=nginx
  ```

  - NAMEï¼š Deploymentåç§°
  - READYï¼šPodçš„çŠ¶æ€ï¼Œå·²ç»Readyçš„ä¸ªæ•°
  - UP-TO-DATEï¼šå·²ç»è¾¾åˆ°æœŸæœ›çŠ¶æ€çš„è¢«æ›´æ–°çš„å‰¯æœ¬æ•°
  - AVAILABLEï¼šå·²ç»å¯ä»¥ç”¨çš„å‰¯æœ¬æ•°
  - AGEï¼šæ˜¾ç¤ºåº”ç”¨ç¨‹åºè¿è¡Œçš„æ—¶é—´
  - CONTAINERSï¼šå®¹å™¨åç§°
  - IMAGESï¼šå®¹å™¨çš„é•œåƒ
  - SELECTORï¼šç®¡ç†çš„Podçš„æ ‡ç­¾

# Deployment çš„æ›´æ–°

- **ä½¿ç”¨ edit å‘½ä»¤æ›´æ–°**

  ```xml
  kubectl edit deploy nginx
  ```

- **ä½¿ç”¨ set å‘½ä»¤æ›´æ–°å¹¶è®°å½•**

  ```bash
  kubectl set image deploy nginx nginx=nginx:1.15.3 â€“record
  ```

- **æŸ¥çœ‹æ›´æ–°è¿‡ç¨‹**

  ```xml
  [root@k8s-master01 ~]# kubectl rollout status deploy nginx
  Waiting for deployment "nginx" rollout to finish: 1 out of 2 new replicas have been updated...
  Waiting for deployment "nginx" rollout to finish: 1 out of 2 new replicas have been updated...
  Waiting for deployment "nginx" rollout to finish: 1 out of 2 new replicas have been updated...
  Waiting for deployment "nginx" rollout to finish: 1 old replicas are pending termination...
  Waiting for deployment "nginx" rollout to finish: 1 old replicas are pending termination...
  deployment "nginx" successfully rolled out
  ```

  <aside> ğŸ’¡ æ›´æ–°è¿‡ç¨‹ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ RSï¼Œç„¶åå°†æ–° RS å‰¯æœ¬æ•°è®¾ç½®ä¸º 1ï¼Œç­‰æ–° RS ä¸‹ 1 ä¸ª Pod å¯åŠ¨æˆåŠŸåï¼Œä»æ—§çš„ RS ä¸­åˆ é™¤ä¸€ä¸ª Podã€‚ä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ°æ‰€æœ‰å‰¯æœ¬éƒ½æ›´æ–°æˆåŠŸã€‚ æœŸé—´æ¯æ¬¡å‰¯æœ¬æ•°è®¾ç½®ä¸ºå‡ ä¸ªï¼Œæ˜¯ç”±æ»šåŠ¨æ›´æ–°ç­–ç•¥æ§åˆ¶çš„ã€‚

  </aside>

- **æˆ–è€…ä½¿ç”¨ describe æŸ¥çœ‹**

  ```xml
  # kubectl describe deploy nginx  
  Normal  ScalingReplicaSet  25m                  deployment-controller  Scaled up replica set nginx-66bbc9fdc5 to 1
  Normal  ScalingReplicaSet  18m (x2 over 23m)    deployment-controller  Scaled up replica set nginx-66bbc9fdc5 to 2
  Normal  ScalingReplicaSet  7m7s                 deployment-controller  Scaled up replica set nginx-5dfc8689c6 to 1
  Normal  ScalingReplicaSet  6m28s (x2 over 23m)  deployment-controller  Scaled down replica set nginx-66bbc9fdc5 to 1
  Normal  ScalingReplicaSet  6m27s                deployment-controller  Scaled up replica set nginx-5dfc8689c6 to 2
  Normal  ScalingReplicaSet  5m58s                deployment-controller  Scaled down replica set nginx-66bbc9fdc5 to 0
  Normal  ScalingReplicaSet  4m19s                deployment-controller  Scaled up replica set nginx-6cdd5dd489 to 1
  Normal  ScalingReplicaSet  3m44s                deployment-controller  Scaled down replica set nginx-5dfc8689c6 to 1
  Normal  ScalingReplicaSet  3m44s                deployment-controller  Scaled up replica set nginx-6cdd5dd489 to 2
  Normal  ScalingReplicaSet  3m6s                 deployment-controller  Scaled down replica set nginx-5dfc8689c6 to 0
  ```

# Deployment å›æ»š

- **æ‰§è¡Œæ›´æ–°æ“ä½œ**

  ```xml
  [root@k8s-master01 ~]# kubectl set image deploy nginx nginx=nginx:787977da --record
  deployment.apps/nginx image updated
  [root@k8s-master01 ~]# kubectl get po 
  NAME                     READY   STATUS              RESTARTS   AGE
  nginx-6cdd5dd489-lv28z   1/1     Running             0          7m12s
  nginx-6cdd5dd489-nqqz7   1/1     Running             0          6m37s
  nginx-7d79b96f68-x7t67   0/1     ContainerCreating   0          19s
  ```

- **æŸ¥çœ‹å†å²ç‰ˆæœ¬**

  ```xml
  [root@k8s-master01 ~]# kubectl rollout history deploy nginx
  deployment.apps/nginx 
  REVISION  CHANGE-CAUSE
  1         <none>
  2         kubectl set image deploy nginx nginx=nginx:1.15.3 --record=true
  5         kubectl set image deploy nginx nginx=nginx:1.15.4 --record=true
  6         kubectl set image deploy nginx nginx=nginx:787977da --record=true
  7         kubectl set image deploy nginx nginx=nginx:787977dadaa --record=true
  8         kubectl set image deploy nginx nginx=nginx:787977xxxxxdadaa --record=true
  9         kubectl set image deploy nginx nginx=nginx:787977dadxxxxxdadaa --record=true
  ```

- **å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬**

  ```xml
  [root@k8s-master01 ~]# kubectl rollout undo deploy nginx 
  deployment.apps/nginx rolled back
  ```

- **æŸ¥çœ‹æŒ‡å®šç‰ˆæœ¬çš„è¯¦ç»†ä¿¡æ¯**

  ```xml
  [root@k8s-master01 ~]# kubectl rollout history deploy nginx --revision=5
  deployment.apps/nginx with revision #5
  Pod Template:
    Labels:	app=nginx
  	pod-template-hash=6cdd5dd489
    Annotations:	kubernetes.io/change-cause: kubectl set image deploy nginx nginx=nginx:1.15.4 --record=true
    Containers:
     nginx:
      Image:	nginx:1.15.4
      Port:	<none>
      Host Port:	<none>
      Environment:	<none>
      Mounts:	<none>
    Volumes:	<none>
  ```

- **å›æ»šåˆ°æŒ‡å®šçš„ç‰ˆæœ¬**

  ```xml
  [root@k8s-master01 ~]# kubectl rollout undo deploy nginx --to-revision=5
  deployment.apps/nginx rolled back
  ```

# Deployment çš„æ‰©ç¼©å®¹

ä½¿ç”¨ kubectl çš„ scale å‘½ä»¤è¿›è¡Œæ‰©ç¼©å®¹ï¼Œ`kubectl scale -h` æŸ¥çœ‹å¸®åŠ©ã€‚

```xml
[root@k8s-master01 ~]# kubectl scale --replicas=3 deploy nginx
deployment.apps/nginx scalde
```

# Deployment çš„æš‚åœå’Œæ¢å¤

æˆ‘ä»¬ä½¿ç”¨ [set å‘½ä»¤æ›´æ–°](https://www.notion.so/Deployment-88ce668e25464666b5c3c2107ec28179) Deployment çš„æ—¶å€™ï¼Œæ¯ set ä¸€æ¬¡éƒ½ä¼šè§¦å‘ä¸€æ¬¡æ›´æ–°ï¼Œå¦‚æœæˆ‘ä»¬æƒ³æ›´æ–°å¤šä¸ªåœ°æ–¹ï¼Œå¦‚é•œåƒã€CPU ç­‰ï¼Œå°±ä¼šè§¦å‘å¤šæ¬¡æ»šåŠ¨å‘å¸ƒã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æš‚åœ Deployment ï¼Œç„¶åå¤šæ¬¡æ‰§è¡Œ set æ›´æ–°ä¹‹åï¼Œå†å›å¤ Deploymentï¼Œå°±å¯ä»¥ä¸€æ¬¡æ€§æ›´æ–°å¤šå¤„ï¼Œåªè§¦å‘ä¸€æ¬¡æ»šåŠ¨å‘å¸ƒäº†ã€‚

1. æš‚åœ Deployment æ›´æ–°

   ```xml
   [root@k8s-master01 ~]# kubectl rollout pause deployment nginx 
   deployment.apps/nginx paused
   ```

2. å¤šæ¬¡ set æ›´æ–°

   ```xml
   [root@k8s-master01 ~]# kubectl set image deploy nginx nginx=nginx:1.15.3 --record
   deployment.apps/nginx image updated
   [root@k8s-master01 ~]# kubectl set resources deploy nginx -c nginx --limits=cpu=200m,memory=128Mi --requests=cpu=10m,memory=16Mi
   deployment.apps/nginx resource requirements updated
   ```

   æ­¤æ—¶é€šè¿‡ `kubectl get deploy nginx -oyaml` å¯ä»¥çœ‹åˆ° yaml å·²ç»æ›´æ–°äº†ï¼Œä½†æ˜¯é€šè¿‡ `kubectl get po` å¯ä»¥çœ‹åˆ° pod å®é™…è¿˜æ²¡æœ‰è¢«æ›´æ–°ã€‚

3. æ¢å¤ Deployment æ›´æ–°

   ```xml
   [root@k8s-master01 ~]# kubectl rollout resume deploy nginx 
   deployment.apps/nginx resumed
   ```

   æ­¤æ—¶å†é€šè¿‡ `kubectl get` rs å’Œ `kubectl get po` å°±å¯ä»¥çœ‹åˆ°çœŸæ­£åœ¨æ›´æ–°äº†ã€‚

# Deployment ç›¸å…³é…ç½®è§£æ

ä½¿ç”¨ `kubectl get deploy nginx -oyaml` æŸ¥çœ‹é…ç½®ï¼š

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    deployment.kubernetes.io/revision: "12"
    kubernetes.io/change-cause: kubectl set image deploy nginx nginx=nginx:1.15.3
      --record=true
  creationTimestamp: "2020-09-19T02:41:11Z"
  generation: 19
  labels:
    app: nginx
  name: nginx
  namespace: default
spec:
  progressDeadlineSeconds: 600
  replicas: 2
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: nginx
  strategy:
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
    type: RollingUpdate
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: nginx
    spec:
      containers:
      - image: nginx:1.15.3
        imagePullPolicy: IfNotPresent
        name: nginx
        resources:
          limits:
            cpu: 200m
            memory: 128Mi
          requests:
            cpu: 10m
            memory: 16Mi
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      terminationGracePeriodSeconds: 30
```

- `.spec.revisionHistoryLimit`ï¼šè®¾ç½®ä¿ç•™ RS æ—§çš„ *revision* çš„ä¸ªæ•°ï¼Œè®¾ç½®ä¸º 0 çš„è¯ï¼Œä¸ä¿ç•™å†å²æ•°æ®
- `.spec.minReadySeconds`ï¼šå¯é€‰å‚æ•°ï¼ŒæŒ‡å®šæ–°åˆ›å»ºçš„ Pod åœ¨æ²¡æœ‰ä»»ä½•å®¹å™¨å´©æºƒçš„æƒ…å†µä¸‹è§†ä¸º Ready æœ€å°çš„ç§’æ•°ï¼Œé»˜è®¤ä¸º 0ï¼Œå³ä¸€æ—¦è¢«åˆ›å»ºå°±è§†ä¸ºå¯ç”¨ã€‚
- `.spec.strategy.type`ï¼šæ»šåŠ¨æ›´æ–°çš„ç­–ç•¥ã€‚æ›´æ–° deployment çš„æ–¹å¼ï¼Œé»˜è®¤æ˜¯ *RollingUpdate*
  - `RollingUpdate`ï¼šæ»šåŠ¨æ›´æ–°ï¼Œå¯ä»¥æŒ‡å®š *maxSurge* å’Œ *maxUnavailable*
    - `maxUnavailable`ï¼šæŒ‡å®šåœ¨å›æ»šæˆ–æ›´æ–°æ—¶æœ€å¤§ä¸å¯ç”¨çš„ Pod çš„æ•°é‡ï¼Œå¯é€‰å­—æ®µï¼Œé»˜è®¤ 25%ï¼Œå¯ä»¥è®¾ç½®æˆæ•°å­—æˆ–ç™¾åˆ†æ¯”ï¼Œå¦‚æœè¯¥å€¼ä¸º 0ï¼Œé‚£ä¹ˆ *maxSurge* å°±ä¸èƒ½ 0
    - `maxSurge`ï¼šå¯ä»¥è¶…è¿‡æœŸæœ›å€¼çš„æœ€å¤§ Pod æ•°ï¼Œå¯é€‰å­—æ®µï¼Œé»˜è®¤ä¸º 25%ï¼Œå¯ä»¥è®¾ç½®æˆæ•°å­—æˆ–ç™¾åˆ†æ¯”ï¼Œå¦‚æœè¯¥å€¼ä¸º 0ï¼Œé‚£ä¹ˆ *maxUnavailable* ä¸èƒ½ä¸º 0
  - `Recreate`ï¼šé‡å»ºï¼Œå…ˆåˆ é™¤æ—§çš„ Podï¼Œå†åˆ›å»ºæ–°çš„ Pod

